<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ENGLISH WITH ZINEB</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <script src="firebase-config.js?v=" + Date.now()></script>
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        .dashboard-container {
            min-height: 100vh;
            background: #f8fafc;
            padding-top: 80px;
        }

        .dashboard-header {
            background: white;
            padding: 2rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dashboard-nav {
            background: white;
            padding: 1rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: #f3f4f6;
            color: #6b7280;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1rem;
            box-shadow:
                0 4px 16px 0 rgba(37, 99, 235, 0.15),
                0 2px 8px 0 rgba(37, 99, 235, 0.10),
                0 1px 4px 0 rgba(0,0,0,0.08);
            z-index: 2;
            position: relative;
        }

        .nav-tab:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
            box-shadow:
                0 8px 24px 0 rgba(37, 99, 235, 0.25),
                0 4px 12px 0 rgba(37, 99, 235, 0.15),
                0 2px 6px 0 rgba(0,0,0,0.12);
        }

        .nav-tab.active {
            background: #2563eb;
            color: white;
            box-shadow:
                0 8px 24px 0 rgba(37, 99, 235, 0.35),
                0 4px 16px 0 rgba(37, 99, 235, 0.25),
                0 2px 8px 0 rgba(37, 99, 235, 0.15);
            transform: translateY(-2px);
        }

        .dashboard-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 22px;
            box-shadow:
                0 24px 64px 0 rgba(37, 99, 235, 0.40),
                0 8px 32px 0 rgba(37, 99, 235, 0.22),
                0 2px 8px 0 rgba(0,0,0,0.18);
            text-align: center;
            z-index: 2;
            position: relative;
        }

        .stat-card i {
            font-size: 2rem;
            color: #2563eb;
            margin-bottom: 0.5rem;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .content-section {
            background: white;
            border-radius: 22px;
            padding: 2rem;
            box-shadow:
                0 24px 64px 0 rgba(37, 99, 235, 0.40),
                0 8px 32px 0 rgba(37, 99, 235, 0.22),
                0 2px 8px 0 rgba(0,0,0,0.18);
            margin-bottom: 2rem;
            z-index: 2;
            position: relative;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .add-video-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-video-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .video-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            color: #1f2937;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2563eb;
            background: white;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #9ca3af;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .video-card {
            background: white;
            border-radius: 22px;
            overflow: hidden;
            box-shadow:
                0 24px 64px 0 rgba(37, 99, 235, 0.40),
                0 8px 32px 0 rgba(37, 99, 235, 0.22),
                0 2px 8px 0 rgba(0,0,0,0.18);
            transition: all 0.3s ease;
            z-index: 2;
            position: relative;
        }

        .video-card:hover {
            transform: translateY(-5px);
            box-shadow:
                0 32px 80px 0 rgba(37, 99, 235, 0.50),
                0 12px 40px 0 rgba(37, 99, 235, 0.30),
                0 4px 12px 0 rgba(0,0,0,0.20);
        }

        .video-thumbnail {
            height: 150px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .video-thumbnail i {
            font-size: 2rem;
            color: white;
        }

        .video-content {
            padding: 1rem;
        }

        .video-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }

        .video-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 1rem;
        }

        .video-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: #fbbf24;
            color: #1f2937;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            background: #f9fafb;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .file-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .file-info {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #f3f4f6;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #374151;
        }

        .upload-progress {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .upload-progress-bar {
            height: 100%;
            background: #3b82f6;
            width: 0%;
            transition: width 0.3s ease;
        }

        .upload-status {
            margin-top: 0.5rem;
            font-size: 0.95rem;
            color: #2563eb;
            min-height: 1.2em;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding-top: 60px;
            }
            
            .dashboard-header {
                padding: 1rem 0;
            }
            
            .dashboard-header h1 {
                font-size: 1.5rem;
                text-align: center;
            }

            .nav-tabs {
                flex-wrap: wrap;
                gap: 0.5rem;
                padding: 0 10px;
            }
            
            .nav-tab {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
                flex: 1;
                min-width: 120px;
            }
            
            .dashboard-content {
                padding: 1rem 10px;
            }
            
            .stats-grid {
                gap: 1rem;
                margin-bottom: 1rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-card i {
                font-size: 1.5rem;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            .content-section {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .section-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
                text-align: center;
            }
            
            .section-header h2 {
                font-size: 1.5rem;
            }
            
            .video-form {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 0.8rem;
                font-size: 0.9rem;
            }
            
            .video-grid {
                gap: 1rem;
            }
            
            .video-card {
                margin-bottom: 1rem;
            }
            
            .video-thumbnail {
                height: 120px;
            }
            
            .video-content {
                padding: 0.8rem;
            }
            
            .video-title {
                font-size: 1rem;
            }
            
            .video-meta {
                font-size: 0.8rem;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .video-actions {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .action-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .add-video-btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .dashboard-header h1 {
                font-size: 1.3rem;
            }
            
            .nav-tab {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
                min-width: 100px;
            }
            
            .stat-card {
                padding: 0.8rem;
            }
            
            .stat-number {
                font-size: 1.3rem;
            }
            
            .content-section {
                padding: 0.8rem;
            }
            
            .section-header h2 {
                font-size: 1.3rem;
            }
            
            .video-thumbnail {
                height: 100px;
            }
            
            .video-content {
                padding: 0.6rem;
            }
            
            .video-title {
                font-size: 0.9rem;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 0.7rem;
                font-size: 0.8rem;
            }
            
            .add-video-btn {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="container">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1><i class="fas fa-graduation-cap"></i> ENGLISH WITH ZINEB - Admin Dashboard</h1>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="dashboard-nav">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('overview')">Overview</button>
                <button class="nav-tab" onclick="switchTab('free-videos')">Free Videos</button>
                <button class="nav-tab" onclick="switchTab('paid-videos')">Paid Videos</button>
                <button class="nav-tab" onclick="switchTab('quizzes')">Quizzes</button>
                <button class="nav-tab" onclick="switchTab('students')">Students</button>
                <button class="nav-tab" onclick="switchTab('messages')">Messages</button>
            </div>
        </nav>

        <!-- Dashboard Content -->
        <main class="dashboard-content">
            <!-- Overview Tab -->
            <div id="overview" class="content-section">
                <h2>Dashboard Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-video"></i>
                        <div class="stat-number" id="totalVideos">12</div>
                        <div class="stat-label">Total Videos</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <div class="stat-number" id="totalStudents">45</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-play-circle"></i>
                        <div class="stat-number" id="freeVideos">8</div>
                        <div class="stat-label">Free Videos</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-crown"></i>
                        <div class="stat-number" id="paidVideos">4</div>
                        <div class="stat-label">Paid Videos</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-question-circle"></i>
                        <div class="stat-number" id="totalQuizzes">0</div>
                        <div class="stat-label">Total Quizzes</div>
                    </div>
                </div>
            </div>

            <!-- Free Videos Tab -->
            <div id="free-videos" class="content-section hidden">
                <div class="section-header">
                    <h2>Free Videos Management</h2>
                    <button class="add-video-btn" onclick="showAddVideoForm('free')">
                        <i class="fas fa-plus"></i> Add Free Video
                    </button>
                </div>

                <div id="addFreeVideoForm" class="hidden">
                    <form onsubmit="addVideo('free', event)">
                        <div class="video-form">
                            <div class="form-group">
                                <label for="freeVideoTitle">Title</label>
                                <input type="text" id="freeVideoTitle" placeholder="Enter video title" required>
                            </div>
                            <div class="form-group">
                                <label for="freeVideoDuration">Duration (min)</label>
                                <input type="number" id="freeVideoDuration" placeholder="Enter duration in minutes" required>
                            </div>
                            <div class="form-group">
                                <label for="freeVideoFile">Video File</label>
                                <div class="file-input-wrapper">
                                    <input type="file" id="freeVideoFile" accept="video/*" class="file-input" required>
                                    <div class="file-info" id="freeVideoFileInfo"></div>
                                    <div class="upload-progress">
                                        <div class="upload-progress-bar" id="freeVideoProgress"></div>
                                    </div>
                                    <div class="upload-status" id="freeVideoStatus"></div>
                                </div>
                            </div>
                            <div class="form-group full-width">
                                <label for="freeVideoDescription">Description</label>
                                <textarea id="freeVideoDescription" rows="3" placeholder="Enter video description" required></textarea>
                            </div>
                        </div>
                        <button type="submit" class="add-video-btn">Add Video</button>
                        <button type="button" class="action-btn edit-btn" onclick="hideAddVideoForm('free')">Cancel</button>
                    </form>
                </div>

                <div class="video-grid" id="freeVideosGrid">
                    <!-- Free videos will be loaded here -->
                </div>
            </div>

            <!-- Paid Videos Tab -->
            <div id="paid-videos" class="content-section hidden">
                <div class="section-header">
                    <h2>Paid Videos Management</h2>
                    <button class="add-video-btn" onclick="showAddVideoForm('paid')">
                        <i class="fas fa-plus"></i> Add Paid Video
                    </button>
                </div>

                <div id="addPaidVideoForm" class="hidden">
                    <form onsubmit="addVideo('paid', event)">
                        <div class="video-form">
                            <div class="form-group">
                                <label for="paidVideoTitle">Title</label>
                                <input type="text" id="paidVideoTitle" placeholder="Enter video title" required>
                            </div>
                            <div class="form-group">
                                <label for="paidVideoDuration">Duration (min)</label>
                                <input type="number" id="paidVideoDuration" placeholder="Enter duration in minutes" required>
                            </div>
                            <div class="form-group">
                                <label for="paidVideoFile">Video File</label>
                                <div class="file-input-wrapper">
                                    <input type="file" id="paidVideoFile" accept="video/*" class="file-input" required>
                                    <div class="file-info" id="paidVideoFileInfo"></div>
                                    <div class="upload-progress">
                                        <div class="upload-progress-bar" id="paidVideoProgress"></div>
                                    </div>
                                    <div class="upload-status" id="paidVideoStatus"></div>
                                </div>
                            </div>
                            <div class="form-group full-width">
                                <label for="paidVideoDescription">Description</label>
                                <textarea id="paidVideoDescription" rows="3" placeholder="Enter video description" required></textarea>
                            </div>
                        </div>
                        <button type="submit" class="add-video-btn">Add Video</button>
                        <button type="button" class="action-btn edit-btn" onclick="hideAddVideoForm('paid')">Cancel</button>
                    </form>
                </div>

                <div class="video-grid" id="paidVideosGrid">
                    <!-- Paid videos will be loaded here -->
                </div>
            </div>

            <!-- Quizzes Tab -->
            <div id="quizzes" class="content-section hidden">
                <div class="section-header">
                    <h2>Quiz Management</h2>
                    <button class="add-video-btn" onclick="showAddQuizForm()">
                        <i class="fas fa-plus"></i> Add Quiz
                    </button>
                </div>

                <div id="addQuizForm" class="hidden">
                    <form onsubmit="addQuiz(event)">
                        <div class="video-form">
                            <div class="form-group">
                                <label for="quizTitle">Quiz Title</label>
                                <input type="text" id="quizTitle" placeholder="Enter quiz title" required>
                            </div>
                            <div class="form-group">
                                <label for="quizImage">Quiz Image</label>
                                <div class="file-input-wrapper">
                                    <input type="file" id="quizImage" accept="image/*" class="file-input" required>
                                    <div class="file-info" id="quizImageInfo"></div>
                                    <div class="upload-progress">
                                        <div class="upload-progress-bar" id="quizImageProgress"></div>
                                    </div>
                                    <div class="upload-status" id="quizImageStatus"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="quizSectionSelect">Section</label>
                                <select id="quizSectionSelect" required onchange="handleSectionChange()"></select>
                                <input type="text" id="quizSectionInput" class="hidden" placeholder="Enter new section name">
                            </div>
                            <div class="form-group">
                                <label for="choice1">Choice 1</label>
                                <input type="text" id="choice1" placeholder="Enter first choice" required>
                            </div>
                            <div class="form-group">
                                <label for="choice2">Choice 2</label>
                                <input type="text" id="choice2" placeholder="Enter second choice" required>
                            </div>
                            <div class="form-group">
                                <label for="choice3">Choice 3</label>
                                <input type="text" id="choice3" placeholder="Enter third choice" required>
                            </div>
                            <div class="form-group">
                                <label for="choice4">Choice 4</label>
                                <input type="text" id="choice4" placeholder="Enter fourth choice" required>
                            </div>
                            <div class="form-group">
                                <label for="correctAnswer">Correct Answer</label>
                                <select id="correctAnswer" required>
                                    <option value="">Select correct answer</option>
                                    <option value="0">Choice 1</option>
                                    <option value="1">Choice 2</option>
                                    <option value="2">Choice 3</option>
                                    <option value="3">Choice 4</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="add-video-btn">Add Quiz</button>
                        <button type="button" class="action-btn edit-btn" onclick="hideAddQuizForm()">Cancel</button>
                    </form>
                </div>

                <div class="video-grid" id="quizzesGrid">
                    <!-- Quizzes will be loaded here -->
                </div>
            </div>

            <!-- Students Tab -->
            <div id="students" class="content-section hidden">
                <div class="section-header">
                    <h2>Students Management</h2>
                    <button class="add-video-btn" onclick="showAddStudentForm()">
                        <i class="fas fa-user-plus"></i> Add Student
                    </button>
                </div>

                <div id="addStudentForm" class="hidden">
                    <form onsubmit="addStudent(event)">
                        <div class="video-form">
                            <div class="form-group">
                                <label for="studentName">Full Name</label>
                                <input type="text" id="studentName" placeholder="Enter student's full name" required>
                            </div>
                            <div class="form-group">
                                <label for="studentEmail">Email</label>
                                <input type="email" id="studentEmail" placeholder="Enter student's email" required>
                            </div>
                            <div class="form-group">
                                <label for="studentPassword">Password</label>
                                <input type="password" id="studentPassword" placeholder="Enter password" required>
                            </div>
                        </div>
                        <button type="submit" class="add-video-btn">Add Student</button>
                        <button type="button" class="action-btn edit-btn" onclick="hideAddStudentForm()">Cancel</button>
                    </form>
                </div>

                <div class="video-grid" id="studentsGrid">
                    <!-- Students will be loaded here -->
                </div>
            </div>

            <!-- Messages Tab -->
            <div id="messages" class="content-section hidden">
                <div class="section-header">
                    <h2>Contact Messages</h2>
                </div>
                <div id="messagesGrid">
                    <!-- Messages will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <script>
        // Check authentication
        window.addEventListener('load', function() {
            // Always force reload if not authenticated (even from cache)
            if (!localStorage.getItem('currentUser')) {
                location.replace('login.html');
                return;
            }
            
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (user.type !== 'admin') {
                window.location.href = 'login.html';
                return;
            }
            
            // Test Firebase Storage connection
            testFirebaseStorage();
            
            loadDashboardData();
            setupFileInputs();
            updateQuizSectionsDropdown(); // Initialize quiz sections dropdown
        });

        // Test Firebase Storage connection
        function testFirebaseStorage() {
            try {
                console.log('=== FIREBASE CONNECTION TEST ===');
                console.log('Firebase app:', firebase.app());
                console.log('Firebase config:', firebase.app().options);
                
                // Test Auth
                console.log('Auth service:', auth);
                console.log('Auth current user:', auth.currentUser);
                
                // Test Firestore
                console.log('Firestore service:', db);
                
                // Test Storage
                console.log('Storage service:', storage);
                console.log('Storage bucket:', storage.app.options.storageBucket);
                
                // Test if we can create references
                const testFirestoreRef = db.collection('test');
                console.log('Firestore reference created:', testFirestoreRef);
                
                const testStorageRef = storage.ref();
                console.log('Storage reference created:', testStorageRef);
                
                console.log('=== ALL FIREBASE SERVICES ARE WORKING ===');
                
            } catch (error) {
                console.error('=== FIREBASE CONNECTION ERROR ===');
                console.error('Error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                if (error.code === 'storage/unauthorized') {
                    alert('Firebase Storage not authorized. Check Storage rules.');
                } else if (error.code === 'firestore/permission-denied') {
                    alert('Firestore permission denied. Check Firestore rules.');
                } else if (error.code === 'auth/unauthorized') {
                    alert('Firebase Auth not authorized. Check Authentication setup.');
                } else {
                    alert('Firebase service unavailable: ' + error.message);
                }
            }
        }

        function setupFileInputs() {
            // Setup file input listeners for both free and paid video forms
            ['free', 'paid'].forEach(type => {
                const fileInput = document.getElementById(`${type}VideoFile`);
                const fileInfo = document.getElementById(`${type}VideoFileInfo`);
                const progressBar = document.getElementById(`${type}VideoProgress`);
                const statusDiv = document.getElementById(`${type}VideoStatus`);
                
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Validate file type
                        if (!file.type.startsWith('video/')) {
                            alert('Please select a valid video file.');
                            fileInput.value = '';
                            fileInfo.innerHTML = '';
                            progressBar.style.width = '0%';
                            statusDiv.textContent = ''; // Clear status
                            return;
                        }
                        
                        // Validate file size (100MB limit)
                        if (file.size > 100 * 1024 * 1024) {
                            alert('Video file size exceeds 100MB limit.');
                            fileInput.value = '';
                            fileInfo.innerHTML = '';
                            progressBar.style.width = '0%';
                            statusDiv.textContent = ''; // Clear status
                            return;
                        }
                        
                        // Display file info
                        const fileSize = (file.size / (1024 * 1024)).toFixed(2);
                        fileInfo.innerHTML = `
                            <strong>Selected:</strong> ${file.name}<br>
                            <strong>Size:</strong> ${fileSize} MB<br>
                            <strong>Type:</strong> ${file.type}
                        `;
                        
                        // Simulate upload progress
                        simulateUploadProgress(progressBar);
                        statusDiv.textContent = "Ready to upload"; // Reset status
                    } else {
                        fileInfo.innerHTML = '';
                        progressBar.style.width = '0%';
                        statusDiv.textContent = ''; // Clear status
                    }
                });
            });

            // Setup quiz image file input
            const quizImageInput = document.getElementById('quizImage');
            const quizImageInfo = document.getElementById('quizImageInfo');
            const quizImageProgress = document.getElementById('quizImageProgress');
            const quizImageStatus = document.getElementById('quizImageStatus');
            
            if (quizImageInput) {
                quizImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Validate file type
                        if (!file.type.startsWith('image/')) {
                            alert('Please select a valid image file.');
                            quizImageInput.value = '';
                            quizImageInfo.innerHTML = '';
                            quizImageProgress.style.width = '0%';
                            quizImageStatus.textContent = ''; // Clear status
                            return;
                        }
                        
                        // Validate file size (5MB limit for images)
                        if (file.size > 5 * 1024 * 1024) {
                            alert('Image file size exceeds 5MB limit.');
                            quizImageInput.value = '';
                            quizImageInfo.innerHTML = '';
                            quizImageProgress.style.width = '0%';
                            quizImageStatus.textContent = ''; // Clear status
                            return;
                        }
                        
                        // Display file info
                        const fileSize = (file.size / (1024 * 1024)).toFixed(2);
                        quizImageInfo.innerHTML = `
                            <strong>Selected:</strong> ${file.name}<br>
                            <strong>Size:</strong> ${fileSize} MB<br>
                            <strong>Type:</strong> ${file.type}
                        `;
                        
                        // Simulate upload progress
                        simulateUploadProgress(quizImageProgress);
                        quizImageStatus.textContent = "Ready to upload"; // Reset status
                    } else {
                        quizImageInfo.innerHTML = '';
                        quizImageProgress.style.width = '0%';
                        quizImageStatus.textContent = ''; // Clear status
                    }
                });
            }
        }

        function simulateUploadProgress(progressBar) {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                }
                progressBar.style.width = progress + '%';
            }, 200);
        }

        function logout() {
            localStorage.removeItem('currentUser');
            // Use location.replace to prevent back navigation
            location.replace('login.html');
        }

        function switchTab(tab) {
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tabBtn => {
                tabBtn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tab).classList.remove('hidden');
            event.target.classList.add('active');

            if (tab === 'messages') {
                loadMessages();
            }
        }

        function showAddVideoForm(type) {
            document.getElementById(`add${type.charAt(0).toUpperCase() + type.slice(1)}VideoForm`).classList.remove('hidden');
        }

        function hideAddVideoForm(type) {
            document.getElementById(`add${type.charAt(0).toUpperCase() + type.slice(1)}VideoForm`).classList.add('hidden');
        }

        function showAddQuizForm() {
            document.getElementById('addQuizForm').classList.remove('hidden');
        }

        function hideAddQuizForm() {
            document.getElementById('addQuizForm').classList.add('hidden');
        }

        function showAddStudentForm() {
            document.getElementById('addStudentForm').classList.remove('hidden');
        }

        function hideAddStudentForm() {
            document.getElementById('addStudentForm').classList.add('hidden');
        }

        async function addVideo(type, event) {
            event.preventDefault();
            
            const title = document.getElementById(`${type}VideoTitle`).value;
            const duration = document.getElementById(`${type}VideoDuration`).value;
            const fileInput = document.getElementById(`${type}VideoFile`);
            const file = fileInput.files[0];
            const description = document.getElementById(`${type}VideoDescription`).value;
            
            if (!file) {
                alert('Please select a video file.');
                return;
            }

            if (file.size > 100 * 1024 * 1024) { // 100MB limit
                alert('Video file size exceeds 100MB limit.');
                return;
            }

            const statusDiv = document.getElementById(`${type}VideoStatus`);
            if (statusDiv) statusDiv.textContent = "Starting upload...";

            try {
                // Show loading state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Uploading...';
                submitBtn.disabled = true;

                // Upload file to Firebase Storage
                const storageRef = storage.ref();
                const videoRef = storageRef.child(`videos/${Date.now()}_${file.name}`);
                
                // Create upload task with progress tracking
                const uploadTask = videoRef.put(file);
                
                // Track upload progress
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        const progressBar = document.getElementById(`${type}VideoProgress`);
                        if (progressBar) {
                            progressBar.style.width = progress + '%';
                        }
                        if (statusDiv) statusDiv.textContent = `Uploading... ${progress.toFixed(0)}%`;
                    },
                    (error) => {
                        console.error('Upload error:', error);
                        alert('Upload failed: ' + error.message);
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        if (statusDiv) statusDiv.textContent = "Upload failed!";
                    },
                    async () => {
                        if (statusDiv) statusDiv.textContent = "Processing video...";
                        try {
                            // Get download URL
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            
                            // Save video data to Firestore
                            const videoData = {
                                title,
                                duration: `${duration} min`,
                                videoUrl: downloadURL,
                                description,
                                type,
                                fileName: file.name,
                                fileSize: (file.size / (1024 * 1024)).toFixed(2) + ' MB',
                                fileType: file.type,
                                uploadDate: new Date()
                            };
                            
                            await DatabaseService.addVideo(videoData);
                            
                            // Reset form and hide it
                            event.target.reset();
                            hideAddVideoForm(type);
                            
                            // Clear file info and progress
                            const fileInfo = document.getElementById(`${type}VideoFileInfo`);
                            const progressBar = document.getElementById(`${type}VideoProgress`);
                            if (fileInfo) fileInfo.innerHTML = '';
                            if (progressBar) progressBar.style.width = '0%';
                            if (statusDiv) statusDiv.textContent = "Upload complete!";
                            
                            // Reload dashboard data
                            loadDashboardData();
                            
                            alert('Video uploaded successfully!');
                            
                        } catch (error) {
                            console.error('Error saving video data:', error);
                            alert('Error saving video data: ' + error.message);
                        } finally {
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    }
                );
                
            } catch (error) {
                console.error('Error uploading video:', error);
                alert('Error uploading video: ' + error.message);
                
                // Reset button state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Add Video';
                submitBtn.disabled = false;
                if (statusDiv) statusDiv.textContent = "Upload failed!";
            }
        }

        async function addQuiz(event) {
            event.preventDefault();
            
            const title = document.getElementById('quizTitle').value;
            const imageFile = document.getElementById('quizImage').files[0];
            const section = document.getElementById('quizSectionSelect').value === '__new__'
                ? document.getElementById('quizSectionInput').value
                : document.getElementById('quizSectionSelect').value;
            const choices = [
                document.getElementById('choice1').value,
                document.getElementById('choice2').value,
                document.getElementById('choice3').value,
                document.getElementById('choice4').value
            ];
            const correctAnswerIndex = parseInt(document.getElementById('correctAnswer').value);

            if (!title || !imageFile || choices.some(c => !c) || isNaN(correctAnswerIndex) || correctAnswerIndex < 0 || correctAnswerIndex > 3) {
                alert('Please fill in all quiz details and select a correct answer.');
                return;
            }

            if (imageFile.size > 5 * 1024 * 1024) { // 5MB limit for image
                alert('Quiz image size exceeds 5MB limit.');
                return;
            }

            const statusDiv = document.getElementById('quizImageStatus');
            if (statusDiv) statusDiv.textContent = "Starting upload...";

            try {
                // Show loading state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Uploading...';
                submitBtn.disabled = true;

                // Upload image to Firebase Storage
                const storageRef = storage.ref();
                const imageRef = storageRef.child(`quizzes/${Date.now()}_${imageFile.name}`);
                
                // Create upload task with progress tracking
                const uploadTask = imageRef.put(imageFile);
                
                // Track upload progress
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        const progressBar = document.getElementById('quizImageProgress');
                        if (progressBar) {
                            progressBar.style.width = progress + '%';
                        }
                        if (statusDiv) statusDiv.textContent = `Uploading... ${progress.toFixed(0)}%`;
                    },
                    (error) => {
                        console.error('Quiz image upload error:', error);
                        alert('Quiz image upload failed: ' + error.message);
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        if (statusDiv) statusDiv.textContent = "Upload failed!";
                    },
                    async () => {
                        if (statusDiv) statusDiv.textContent = "Processing quiz...";
                        try {
                            // Get download URL
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            
                            // Save quiz data to Firestore
                            const quizData = {
                                title,
                                imageUrl: downloadURL,
                                section,
                                choices,
                                correctAnswerIndex,
                                createdAt: new Date()
                            };
                            
                            await DatabaseService.addQuiz(quizData);
                            
                            // Reset form and hide it
                            event.target.reset();
                            hideAddQuizForm();
                            
                            // Clear file info and progress
                            const fileInfo = document.getElementById('quizImageInfo');
                            const progressBar = document.getElementById('quizImageProgress');
                            if (fileInfo) fileInfo.innerHTML = '';
                            if (progressBar) progressBar.style.width = '0%';
                            if (statusDiv) statusDiv.textContent = "Upload complete!";
                            
                            // Reload dashboard data
                            loadDashboardData();
                            
                            alert('Quiz uploaded successfully!');
                            
                        } catch (error) {
                            console.error('Error saving quiz data:', error);
                            alert('Error saving quiz data: ' + error.message);
                        } finally {
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    }
                );
                
            } catch (error) {
                console.error('Error uploading quiz:', error);
                alert('Error uploading quiz: ' + error.message);
                
                // Reset button state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Add Quiz';
                submitBtn.disabled = false;
                if (statusDiv) statusDiv.textContent = "Upload failed!";
            }
        }

        async function addStudent(event) {
            event.preventDefault();
            
            const name = document.getElementById('studentName').value;
            const email = document.getElementById('studentEmail').value;
            const password = document.getElementById('studentPassword').value;
            
            try {
                // Show loading state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Creating...';
                submitBtn.disabled = true;

                // Create Firebase user account
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Save user data to Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    type: 'student',
                    createdAt: new Date()
                });

                // Save to localStorage for admin dashboard display
                const student = {
                    id: userCredential.user.uid,
                    name,
                    email,
                    type: 'student'
                };
                
                const students = JSON.parse(localStorage.getItem('students') || '[]');
                students.push(student);
                localStorage.setItem('students', JSON.stringify(students));
                
                // Reset form and hide it
                event.target.reset();
                hideAddStudentForm();
                
                // Reload dashboard data
                loadDashboardData();
                
                alert('Student account created successfully! They can now login with their email and password.');
                
            } catch (error) {
                console.error('Error creating student:', error);
                
                let errorMessage = 'Error creating student account. ';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage += 'This email is already registered.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage += 'Password should be at least 6 characters.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage += 'Please enter a valid email address.';
                } else {
                    errorMessage += error.message;
                }
                
                alert(errorMessage);
            } finally {
                // Reset button state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Add Student';
                submitBtn.disabled = false;
            }
        }

        async function deleteVideo(id) {
            if (confirm('Are you sure you want to delete this video?')) {
                try {
                    await DatabaseService.deleteVideo(id);
                    loadDashboardData();
                    alert('Video deleted successfully!');
                } catch (error) {
                    console.error('Error deleting video:', error);
                    alert('Error deleting video: ' + error.message);
                }
            }
        }

        async function deleteStudent(id) {
            if (confirm('Are you sure you want to delete this student? This will permanently delete their account.')) {
                try {
                    // Delete from Firestore
                    await db.collection('users').doc(id).delete();
                    
                    // Note: Firebase Auth user deletion requires admin SDK
                    // For now, we'll just delete from Firestore
                    // The user won't be able to login anymore since we check user type in Firestore
                    
                    loadDashboardData();
                    alert('Student deleted successfully!');
                } catch (error) {
                    console.error('Error deleting student:', error);
                    alert('Error deleting student: ' + error.message);
                }
            }
        }

        // Add a variable to track which video is being edited
        let editingVideoId = null;

        // Update loadDashboardData to support edit mode
        async function loadDashboardData() {
            try {
                const videos = await DatabaseService.getVideos();
                const students = await DatabaseService.getStudents();
                const quizzes = await DatabaseService.getQuizzes();
                
                // Update stats
                document.getElementById('totalVideos').textContent = videos.length;
                document.getElementById('totalStudents').textContent = students.length;
                document.getElementById('freeVideos').textContent = videos.filter(v => v.type === 'free').length;
                document.getElementById('paidVideos').textContent = videos.filter(v => v.type === 'paid').length;
                document.getElementById('totalQuizzes').textContent = quizzes.length;
                
                // Load free videos
                const freeVideosGrid = document.getElementById('freeVideosGrid');
                const freeVideos = videos.filter(v => v.type === 'free');
                freeVideosGrid.innerHTML = freeVideos.length > 0 ? freeVideos.map(video => {
                    if (editingVideoId === video.id) {
                        // Edit mode form
                        return `
                        <div class="video-card">
                            <form onsubmit="saveVideoEdit('${video.id}', event)">
                                <div class='form-group'>
                                    <label>Title</label>
                                    <input type='text' id='editTitle' value="${video.title.replace(/"/g, '&quot;')}" required />
                                </div>
                                <div class='form-group'>
                                    <label>Duration (min)</label>
                                    <input type='number' id='editDuration' value="${parseInt(video.duration)}" required />
                                </div>
                                <div class='form-group'>
                                    <label>Description</label>
                                    <textarea id='editDescription' rows='3' required>${video.description}</textarea>
                                </div>
                                <button type='submit' class='add-video-btn'>Save</button>
                                <button type='button' class='action-btn edit-btn' onclick='cancelVideoEdit()'>Cancel</button>
                            </form>
                        </div>
                        `;
                    } else {
                        return `
                        <div class="video-card">
                            <div class="video-thumbnail">
                                ${video.videoUrl ? `
                                    <video controls style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px;">
                                        <source src="${video.videoUrl}" type="${video.fileType}">
                                        Your browser does not support the video tag.
                                    </video>
                                ` : '<i class="fas fa-play-circle"></i>'}
                            </div>
                            <div class="video-content">
                                <h3 class="video-title">${video.title}</h3>
                                <div class="video-meta">
                                    <span><i class="fas fa-clock"></i> ${video.duration}</span>
                                    ${video.fileSize ? `<span><i class="fas fa-file"></i> ${video.fileSize}</span>` : ''}
                                </div>
                                <p style="font-size: 0.9rem; color: #6b7280; margin: 0.5rem 0;">${video.description}</p>
                                <div class="video-actions">
                                    <button class="action-btn edit-btn" onclick="editVideo('${video.id}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="action-btn delete-btn" onclick="deleteVideo('${video.id}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        `;
                    }
                }).join('') : '<p style="text-align: center; color: #6b7280; grid-column: 1 / -1; padding: 2rem;">No free videos uploaded yet. Click "Add Free Video" to get started!</p>';
                
                // Load paid videos
                const paidVideosGrid = document.getElementById('paidVideosGrid');
                const paidVideos = videos.filter(v => v.type === 'paid');
                paidVideosGrid.innerHTML = paidVideos.length > 0 ? paidVideos.map(video => {
                    if (editingVideoId === video.id) {
                        // Edit mode form
                        return `
                        <div class="video-card">
                            <form onsubmit="saveVideoEdit('${video.id}', event)">
                                <div class='form-group'>
                                    <label>Title</label>
                                    <input type='text' id='editTitle' value="${video.title.replace(/"/g, '&quot;')}" required />
                                </div>
                                <div class='form-group'>
                                    <label>Duration (min)</label>
                                    <input type='number' id='editDuration' value="${parseInt(video.duration)}" required />
                                </div>
                                <div class='form-group'>
                                    <label>Description</label>
                                    <textarea id='editDescription' rows='3' required>${video.description}</textarea>
                                </div>
                                <button type='submit' class='add-video-btn'>Save</button>
                                <button type='button' class='action-btn edit-btn' onclick='cancelVideoEdit()'>Cancel</button>
                            </form>
                        </div>
                        `;
                    } else {
                        return `
                        <div class="video-card">
                            <div class="video-thumbnail">
                                ${video.videoUrl ? `
                                    <video controls style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px;">
                                        <source src="${video.videoUrl}" type="${video.fileType}">
                                        Your browser does not support the video tag.
                                    </video>
                                ` : '<i class="fas fa-crown"></i>'}
                            </div>
                            <div class="video-content">
                                <h3 class="video-title">${video.title}</h3>
                                <div class="video-meta">
                                    <span><i class="fas fa-clock"></i> ${video.duration}</span>
                                    ${video.fileSize ? `<span><i class="fas fa-file"></i> ${video.fileSize}</span>` : ''}
                                </div>
                                <p style="font-size: 0.9rem; color: #6b7280; margin: 0.5rem 0;">${video.description}</p>
                                <div class="video-actions">
                                    <button class="action-btn edit-btn" onclick="editVideo('${video.id}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="action-btn delete-btn" onclick="deleteVideo('${video.id}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        `;
                    }
                }).join('') : '<p style="text-align: center; color: #6b7280; grid-column: 1 / -1; padding: 2rem;">No paid videos uploaded yet. Click "Add Paid Video" to get started!</p>';
                
                // Load quizzes
                const quizzesGrid = document.getElementById('quizzesGrid');
                if (quizzes.length > 0) {
                    // Group quizzes by section
                    const sectionGroups = {};
                    quizzes.forEach(quiz => {
                        const section = quiz.section || 'Uncategorized';
                        if (!sectionGroups[section]) sectionGroups[section] = [];
                        sectionGroups[section].push(quiz);
                    });
                    quizzesGrid.innerHTML = Object.keys(sectionGroups).map(section => {
                        const quizzesHtml = sectionGroups[section].map(quiz => {
                            if (editingVideoId === quiz.id) {
                                return `
                                <div class="video-card">
                                    <form onsubmit="saveQuizEdit('${quiz.id}', event)">
                                        <div class='form-group'>
                                            <label>Title</label>
                                            <input type='text' id='editTitle' value="${quiz.title.replace(/"/g, '&quot;')}" required />
                                        </div>
                                        <div class='form-group'>
                                            <label>Image</label>
                                            <div class="file-input-wrapper">
                                                <input type="file" id="editImage" accept="image/*" class="file-input">
                                                <div class="file-info" id="editImageInfo"></div>
                                                <div class="upload-progress">
                                                    <div class="upload-progress-bar" id="editImageProgress"></div>
                                                </div>
                                                <div class="upload-status" id="editImageStatus"></div>
                                            </div>
                                        </div>
                                        <div class='form-group'>
                                            <label>Section</label>
                                            <select id='editSectionSelect' required onchange="handleSectionChange()">
                                                <option value="${quiz.section || 'Uncategorized'}" selected>${quiz.section || 'Uncategorized'}</option>
                                                <option value="__new__">Add new section...</option>
                                            </select>
                                            <input type="text" id="editSectionInput" class="hidden" value="${quiz.section || ''}" placeholder="Enter new section name">
                                        </div>
                                        <div class='form-group'>
                                            <label>Choice 1</label>
                                            <input type='text' id='editChoice1' value="${quiz.choices[0]}" required />
                                        </div>
                                        <div class='form-group'>
                                            <label>Choice 2</label>
                                            <input type='text' id='editChoice2' value="${quiz.choices[1]}" required />
                                        </div>
                                        <div class='form-group'>
                                            <label>Choice 3</label>
                                            <input type='text' id='editChoice3' value="${quiz.choices[2]}" required />
                                        </div>
                                        <div class='form-group'>
                                            <label>Choice 4</label>
                                            <input type='text' id='editChoice4' value="${quiz.choices[3]}" required />
                                        </div>
                                        <div class='form-group'>
                                            <label>Correct Answer</label>
                                            <select id='editCorrectAnswer' required>
                                                <option value="0" ${quiz.correctAnswerIndex === 0 ? 'selected' : ''}>Choice 1</option>
                                                <option value="1" ${quiz.correctAnswerIndex === 1 ? 'selected' : ''}>Choice 2</option>
                                                <option value="2" ${quiz.correctAnswerIndex === 2 ? 'selected' : ''}>Choice 3</option>
                                                <option value="3" ${quiz.correctAnswerIndex === 3 ? 'selected' : ''}>Choice 4</option>
                                            </select>
                                        </div>
                                        <button type='submit' class='add-video-btn'>Save</button>
                                        <button type='button' class='action-btn edit-btn' onclick='cancelQuizEdit()'>Cancel</button>
                                    </form>
                                </div>
                                `;
                            } else {
                                return `
                                <div class="video-card">
                                    <div class="video-thumbnail">
                                        ${quiz.imageUrl ? `
                                            <img src="${quiz.imageUrl}" alt="Quiz Image" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px;">
                                        ` : '<i class="fas fa-image"></i>'}
                                    </div>
                                    <div class="video-content">
                                        <h3 class="video-title">${quiz.title}</h3>
                                        <div class="video-meta">
                                            <span><i class="fas fa-image"></i> Quiz</span>
                                            <span style='color: #059669; font-weight: 600;'>${quiz.section || 'Uncategorized'}</span>
                                        </div>
                                        <p style="font-size: 0.9rem; color: #6b7280; margin: 0.5rem 0;">${quiz.description || 'No description available.'}</p>
                                        <div class="video-actions">
                                            <button class="action-btn edit-btn" onclick="editQuiz('${quiz.id}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="action-btn delete-btn" onclick="deleteQuiz('${quiz.id}')">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                `;
                            }
                        }).join('');
                        return `
                            <div style='grid-column: 1 / -1; margin-bottom: 1rem;'>
                                <h3 style='color: #2563eb; margin-bottom: 0.5rem;'>${section}</h3>
                            </div>
                            ${quizzesHtml}
                        `;
                    }).join('');
                } else {
                    quizzesGrid.innerHTML = '<p style="text-align: center; color: #6b7280; grid-column: 1 / -1; padding: 2rem;">No quizzes uploaded yet. Click "Add Quiz" to get started!</p>';
                }
                
                // Load students
                const studentsGrid = document.getElementById('studentsGrid');
                const studentUsers = students.filter(student => student.type === 'student');
                studentsGrid.innerHTML = studentUsers.length > 0 ? studentUsers.map(student => `
                    <div class="video-card">
                        <div class="video-thumbnail">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="video-content">
                            <h3 class="video-title">${student.name}</h3>
                            <div class="video-meta">
                                <span><i class="fas fa-envelope"></i> ${student.email}</span>
                                <span><i class="fas fa-calendar"></i> ${student.createdAt ? new Date(student.createdAt.toDate()).toLocaleDateString() : 'N/A'}</span>
                            </div>
                            <div class="video-actions">
                                <button class="action-btn delete-btn" onclick="deleteStudent('${student.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('') : '<p style="text-align: center; color: #6b7280; grid-column: 1 / -1; padding: 2rem;">No students registered yet. Click "Add Student" to get started!</p>';
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                alert('Error loading dashboard data: ' + error.message);
            }
        }

        async function loadMessages() {
            const messagesGrid = document.getElementById('messagesGrid');
            messagesGrid.innerHTML = '<p style="color: #6b7280;">Loading messages...</p>';
            try {
                const messages = await DatabaseService.getMessages();
                
                if (messages.length === 0) {
                    messagesGrid.innerHTML = '<p style="color: #6b7280;">No messages yet.</p>';
                    return;
                }
                
                messagesGrid.innerHTML = messages.map(message => {
                    const date = message.createdAt && message.createdAt.toDate ? message.createdAt.toDate().toLocaleString() : 
                               (message.createdAt ? new Date(message.createdAt).toLocaleString() : '');
                    const statusClass = message.status === 'unread' ? 'unread-message' : 'read-message';
                    return `
                        <div class="${statusClass}" style="background: #f9fafb; border-radius: 8px; margin-bottom: 1rem; padding: 1rem; box-shadow: 0 1px 4px rgba(0,0,0,0.04); position: relative; border-left: 4px solid ${message.status === 'unread' ? '#2563eb' : '#10b981'};">
                            <div style="font-weight: bold; color: #2563eb;">${message.name} &lt;${message.email}&gt;</div>
                            <div style="color: #374151; margin: 0.5rem 0;">${message.message}</div>
                            <div style="font-size: 0.9rem; color: #6b7280;">
                                ${date}
                                <span style="margin-left: 1rem; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; background: ${message.status === 'unread' ? '#dbeafe' : '#d1fae5'}; color: ${message.status === 'unread' ? '#1e40af' : '#065f46'};">
                                    ${message.status === 'unread' ? 'Unread' : 'Read'}
                                </span>
                            </div>
                            <div style="position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem;">
                                ${message.status === 'unread' ? 
                                    `<button class="action-btn edit-btn" onclick="markMessageAsRead('${message.id}')" title="Mark as Read">
                                        <i class="fas fa-check"></i>
                                    </button>` : ''
                                }
                                <button class="action-btn delete-btn" onclick="deleteMessage('${message.id}')" title="Delete Message">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading messages:', error);
                messagesGrid.innerHTML = '<p style="color: #ef4444;">Failed to load messages: ' + error.message + '</p>';
            }
        }

        // Edit video functions
        function editVideo(id) {
            editingVideoId = id;
            loadDashboardData();
        }
        function cancelVideoEdit() {
            editingVideoId = null;
            loadDashboardData();
        }
        async function saveVideoEdit(id, event) {
            event.preventDefault();
            const title = document.getElementById('editTitle').value;
            const duration = document.getElementById('editDuration').value;
            const description = document.getElementById('editDescription').value;
            try {
                await db.collection('videos').doc(id).update({
                    title,
                    duration: duration + ' min',
                    description
                });
                editingVideoId = null;
                loadDashboardData();
                alert('Video updated successfully!');
            } catch (error) {
                alert('Error updating video: ' + error.message);
            }
        }

        function editStudent(id) {
            // Implementation for editing student
            alert('Edit functionality would be implemented here');
        }

        // Add deleteMessage function
        async function deleteMessage(id) {
            if (confirm('Are you sure you want to delete this message?')) {
                try {
                    await DatabaseService.deleteMessage(id);
                    loadMessages();
                    alert('Message deleted successfully!');
                } catch (error) {
                    console.error('Error deleting message:', error);
                    alert('Error deleting message: ' + error.message);
                }
            }
        }

        // Add markMessageAsRead function
        async function markMessageAsRead(id) {
            try {
                await DatabaseService.markMessageAsRead(id);
                loadMessages();
                console.log('Message marked as read:', id);
            } catch (error) {
                console.error('Error marking message as read:', error);
                alert('Error marking message as read: ' + error.message);
            }
        }

        // Add deleteQuiz function
        async function deleteQuiz(id) {
            if (confirm('Are you sure you want to delete this quiz?')) {
                try {
                    await DatabaseService.deleteQuiz(id);
                    loadDashboardData();
                    alert('Quiz deleted successfully!');
                } catch (error) {
                    console.error('Error deleting quiz:', error);
                    alert('Error deleting quiz: ' + error.message);
                }
            }
        }

        // Add saveQuizEdit function
        async function saveQuizEdit(id, event) {
            event.preventDefault();
            const title = document.getElementById('editTitle').value;
            const imageFile = document.getElementById('editImage').files[0];
            const section = document.getElementById('editSectionSelect').value === '__new__'
                ? document.getElementById('editSectionInput').value
                : document.getElementById('editSectionSelect').value;
            const choices = [
                document.getElementById('editChoice1').value,
                document.getElementById('editChoice2').value,
                document.getElementById('editChoice3').value,
                document.getElementById('editChoice4').value
            ];
            const correctAnswerIndex = parseInt(document.getElementById('editCorrectAnswer').value);

            if (!title || !imageFile || choices.some(c => !c) || isNaN(correctAnswerIndex) || correctAnswerIndex < 0 || correctAnswerIndex > 3) {
                alert('Please fill in all quiz details and select a correct answer.');
                return;
            }

            if (imageFile.size > 5 * 1024 * 1024) { // 5MB limit for image
                alert('Quiz image size exceeds 5MB limit.');
                return;
            }

            const statusDiv = document.getElementById('editImageStatus');
            if (statusDiv) statusDiv.textContent = "Starting upload...";

            try {
                // Show loading state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Uploading...';
                submitBtn.disabled = true;

                // Upload image to Firebase Storage
                const storageRef = storage.ref();
                const imageRef = storageRef.child(`quizzes/${Date.now()}_${imageFile.name}`);
                
                // Create upload task with progress tracking
                const uploadTask = imageRef.put(imageFile);
                
                // Track upload progress
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        const progressBar = document.getElementById('editImageProgress');
                        if (progressBar) {
                            progressBar.style.width = progress + '%';
                        }
                        if (statusDiv) statusDiv.textContent = `Uploading... ${progress.toFixed(0)}%`;
                    },
                    (error) => {
                        console.error('Quiz image upload error:', error);
                        alert('Quiz image upload failed: ' + error.message);
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        if (statusDiv) statusDiv.textContent = "Upload failed!";
                    },
                    async () => {
                        if (statusDiv) statusDiv.textContent = "Processing quiz...";
                        try {
                            // Get download URL
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            
                            // Save quiz data to Firestore
                            const quizData = {
                                title,
                                imageUrl: downloadURL,
                                section,
                                choices,
                                correctAnswerIndex,
                                createdAt: new Date()
                            };
                            
                            await DatabaseService.updateQuiz(id, quizData);
                            
                            // Reset form and hide it
                            event.target.reset();
                            hideAddQuizForm();
                            
                            // Clear file info and progress
                            const fileInfo = document.getElementById('editImageInfo');
                            const progressBar = document.getElementById('editImageProgress');
                            if (fileInfo) fileInfo.innerHTML = '';
                            if (progressBar) progressBar.style.width = '0%';
                            if (statusDiv) statusDiv.textContent = "Upload complete!";
                            
                            // Reload dashboard data
                            loadDashboardData();
                            
                            alert('Quiz updated successfully!');
                            
                        } catch (error) {
                            console.error('Error saving quiz data:', error);
                            alert('Error saving quiz data: ' + error.message);
                        } finally {
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }
                    }
                );
                
            } catch (error) {
                console.error('Error uploading quiz:', error);
                alert('Error uploading quiz: ' + error.message);
                
                // Reset button state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Add Quiz';
                submitBtn.disabled = false;
                if (statusDiv) statusDiv.textContent = "Upload failed!";
            }
        }

        function editQuiz(id) {
            editingVideoId = id; // Assuming quiz ID is the same as video ID for now
            loadDashboardData();
        }

        function cancelQuizEdit() {
            editingVideoId = null;
            loadDashboardData();
        }

        let quizSections = [];
        let predefinedSections = [
            'Grammar',
            'Vocabulary',
            'Listening',
            'Reading',
            'Pronunciation',
            'Writing',
            'General English'
        ];

        async function updateQuizSectionsDropdown() {
            const quizzes = await DatabaseService.getQuizzes();
            let dbSections = quizzes.map(q => q.section || 'Uncategorized');
            // Remove duplicates and predefined
            dbSections = [...new Set(dbSections.filter(s => !predefinedSections.includes(s)))];
            const allSections = [...predefinedSections, ...dbSections];
            const sectionSelect = document.getElementById('quizSectionSelect');
            if (sectionSelect) {
                sectionSelect.innerHTML = allSections.map(section => `<option value="${section}">${section}</option>`).join('') + '<option value="__new__">Add new section...</option>';
            }
        }

        function handleSectionChange() {
            const select = document.getElementById('quizSectionSelect');
            const input = document.getElementById('quizSectionInput');
            if (select.value === '__new__') {
                input.classList.remove('hidden');
                input.required = true;
            } else {
                input.classList.add('hidden');
                input.required = false;
            }
        }
    </script>
</body>
</html> 